# MCP Server v2.1 - 架構文件

本文件提供 MCP Server 系統架構、組件和所使用工具的技術概覽。

## 1. 系統架構

該系統被設計為一個由 API 驅動的知識庫伺服器，它實現了一個名為 **MCP (Model Context Protocol)** 的專有協定。MCP 的核心概念是為 AI 客戶端（如 `gemini-cli`）提供一個專門的通道來學習和檢索上下文資訊。雖然底層使用 HTTP 技術，但它的設計並非為了通用的 REST 客戶端，而是為 AI 的特定需求量身打造。

此架構可分為三個主要層次：

1.  **MCP 層 (FastAPI):** 一個 Web 伺服器，它實現了 MCP 協定，並提供與知識庫互動的端點。這是 AI 客戶端的唯一入口點。
2.  **嵌入層 (SentenceTransformer):** 一個機器學習模型，負責將基於文字的知識和查詢轉換為數值向量表示（embeddings）。
3.  **儲存與查詢層 (ChromaDB):** 一個專門的向量資料庫，用於儲存嵌入向量及其相關的元數據。它為高效的相似性搜尋和基於元數據的過濾提供了核心功能。

## 2. 核心技術與 MCP 實作工具

- **MCP 協定實作:**
  - **FastAPI:** 一個現代、高效能的 Python Web 框架，被用來建構並實現 MCP 協定的伺服器端。它提供了處理 HTTP 請求、資料驗證（透過 Pydantic）和 API 文件自動生成的功能。

- **向量資料庫:**
  - **ChromaDB:** 一個開源的嵌入資料庫。它在測試中作為記憶體資料庫使用，在開發/生產中作為持久化的磁碟資料庫，儲存所有知識點向量及其元數據。

- **嵌入模型:**
  - **SentenceTransformer (`all-MiniLM-L6-v2`):** 一個用於生成最先進的句子和文字嵌入的 Python 函式庫。此模型用於將儲存的知識和傳入的搜尋查詢轉換為向量，以進行語意比較。

- **測試框架:**
  - **Pytest:** 用於編寫和執行測試的主要框架。
  - **HTTPX:** 一個現代的 HTTP 客戶端，在 `pytest` 中用於在測試期間向 FastAPI 應用程式發出請求。

- **容器化:**
  - **Docker & Docker Compose:** 該應用程式已完全容器化。`Dockerfile` 定義了映像檔，而 `docker-compose.yml` 檔案則用於編排服務，使其易於建置、執行和部署。

## 3. API 端點

伺服器提供三個主要端點：

- `POST /learn`
  - **目的：** 將一個新的知識點加入資料庫。
  - **請求主體：** `{ "topic": "string", "content": "string" }`
  - **流程：** 為 `content` 生成一個嵌入，並將其與 `topic` 元數據一起儲存。

- `POST /search`
  - **目的：** 在知識庫上執行語意搜尋。
  - **請求主體：** `{ "query": "string", "topic": "string" (選填), "top_k": integer }`
  - **流程：** 找到與 `query` 語意最相似的 `top_k` 個知識點。如果提供了 `topic`，則搜尋將被過濾到該主題內。

- `GET /retrieve`
  - **目的：** 獲取特定主題的所有知識點。
  - **查詢參數：** `?topic=string`
  - **流程：** 返回所有元數據與給定 `topic` 相符的文件。