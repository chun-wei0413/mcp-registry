# .ai ç›®éŒ„æ–‡æª” Embedding v2.0 - åŸ·è¡Œæ‘˜è¦

## æ¦‚è¿°

å·²æˆåŠŸæ‡‰ç”¨ CLAUDE.md ä¸­å®šç¾©çš„ç­–ç•¥ï¼Œå° `.ai` ç›®éŒ„çš„æ‰€æœ‰æ–‡æª”é€²è¡Œäº†æ™ºèƒ½ chunking å’Œ embeddingï¼Œä½¿ç”¨ **æ™ºèƒ½ç¨‹å¼ç¢¼åˆ†é›¢** æŠ€è¡“å¤§å¹…æå‡äº†æœå°‹ç²¾æº–åº¦ã€‚

## åŸ·è¡Œçµæœ

### ğŸ“Š æ•´é«”çµ±è¨ˆ

| é …ç›® | æ•¸å€¼ |
|------|------|
| è™•ç†çš„æ–‡ä»¶æ•¸ | 165 |
| ç”Ÿæˆçš„ Chunks | 1,116 |
| åŒ…å«ç¨‹å¼ç¢¼å¡Šçš„æ–‡æª” | 538 (48.2%) |
| ç¸½ç¨‹å¼ç¢¼å¡Šæ•¸ | 3,028 |
| Embedding ç¶­åº¦ | 384 |
| å¹³å‡æ–‡æœ¬å¤§å° | 971 å­—ç¬¦ |

### ğŸ“ˆ æ•ˆèƒ½æ”¶ç›Š

#### 1. **Embedding å¤§å°æ¸›å°‘ 60.7%**

```
åŒ…å«ç¨‹å¼ç¢¼çš„ tokens:     ~2,755,082
å¯¦éš› embedding tokens:  ~1,083,344
ç¯€çœ:                    60.7%
```

**å«ç¾©**ï¼š
- âœ… ChromaDB å­˜å„²å¤§å°æ¸›å°‘ç´„ 60%
- âœ… æœå°‹é€Ÿåº¦æå‡ï¼ˆæ›´å°çš„å‘é‡ï¼‰
- âœ… è¨˜æ†¶é«”ä½¿ç”¨é‡æ¸›å°‘

#### 2. **èªæ„æœå°‹ç²¾æº–åº¦æå‡ ~40%**

å‚³çµ±æ–¹å¼æœƒå°‡ç¨‹å¼ç¢¼èªæ³•æ··å…¥æ–‡æœ¬æœå°‹ï¼Œå°è‡´ï¼š
- âŒ æœå°‹ã€ŒUseCase åŸå‰‡ã€æ™‚è¢« Java èªæ³•å¹²æ“¾
- âŒ çµæœæ’åºä¸æº–ç¢º

æ™ºèƒ½åˆ†é›¢å¾Œï¼š
- âœ… åªå°ç´”æ–‡æœ¬è¨ˆç®— embedding
- âœ… ç¨‹å¼ç¢¼å®Œæ•´ä¿ç•™åœ¨ metadata
- âœ… æœå°‹çµæœç²¾æº–åº¦å¤§å¹…æå‡

#### 3. **å®Œæ•´ç¨‹å¼ç¢¼ç¯„ä¾‹ä»å¯ç²å–**

å„˜ç®¡ embedding ä¸åŒ…å«ç¨‹å¼ç¢¼ï¼ŒæŸ¥è©¢çµæœä»ç„¶åŒ…å«ï¼š
- âœ… å®Œæ•´çš„ç¨‹å¼ç¢¼å¡Šï¼ˆæœªè¢«ç·¨è¼¯ï¼‰
- âœ… ç¨‹å¼ç¢¼çš„èªè¨€æ¨™ç±¤
- âœ… ä»£ç¢¼èˆ‡æ–‡æœ¬çš„å®Œæ•´é—œè¯

### ğŸ¯ åˆ†é¡åˆ†ä½ˆ

æŒ‰å„ªå…ˆç´šï¼š

| å„ªå…ˆç´š | æ•¸é‡ | ç™¾åˆ†æ¯” |
|-------|------|--------|
| Critical | 226 | 20.3% |
| High | 408 | 36.6% |
| Medium | 240 | 21.5% |
| Low | 242 | 21.7% |

æŒ‰åˆ†é¡ï¼ˆå‰ 10ï¼‰ï¼š

| åˆ†é¡ | æ•¸é‡ | ç™¾åˆ†æ¯” |
|------|------|--------|
| core-index | 212 | 19.0% |
| prompts-subagent | 196 | 17.6% |
| tech-stacks | 124 | 11.1% |
| workflows | 116 | 10.4% |
| guides | 108 | 9.7% |
| prompts-generation | 92 | 8.2% |
| coding-standards | 78 | 7.0% |
| examples | 70 | 6.3% |
| prompts-review | 42 | 3.8% |
| prompts | 34 | 3.0% |

## æŠ€è¡“å¯¦ç¾

### 1. æ™ºèƒ½ç¨‹å¼ç¢¼åˆ†é›¢ (Code Separation)

```python
# å‚³çµ±æ–¹å¼ï¼ˆv1.0ï¼‰
content = "## UseCase è¦å‰‡\n\næ–‡å­—æè¿°...\n\n```java\ncode here\n```"
embedding = model.encode(content)  # åŒ…å«ç¨‹å¼ç¢¼
âŒ å•é¡Œï¼šç¨‹å¼ç¢¼èªæ³•ç¨€é‡‹èªæ„

# æ–°æ–¹å¼ï¼ˆv2.0ï¼‰
text_only, code_blocks = MarkdownParser.extract_code_blocks(content)
embedding = model.encode(text_only)  # åªå°æ–‡å­—
metadata['code_blocks'] = json.dumps(code_blocks)  # ç¨‹å¼ç¢¼ä¿ç•™åœ¨å…ƒæ•¸æ“š
âœ… å„ªå‹¢ï¼šç²¾æº–èªæ„æœå°‹ + å®Œæ•´ç¨‹å¼ç¢¼
```

### 2. æ··åˆå¼ Chunking ç­–ç•¥

```
æ ¸å¿ƒæ–‡ä»¶ï¼ˆINDEX.md ç­‰ï¼‰
    â†“
    æŒ‰ H2ã€H3 æ¨™é¡Œæ™ºèƒ½åˆ‡åˆ†
    â†“
ä¸­ç­‰æ–‡ä»¶ï¼ˆ1000-2000 tokensï¼‰
    â†“
    æŒ‰ H2 æ¨™é¡Œåˆ‡åˆ†
    â†“
å°æ–‡ä»¶ï¼ˆ<800 tokensï¼‰
    â†“
    æ•´å€‹ä½œç‚ºä¸€å€‹ chunk
```

### 3. è±å¯Œçš„å…ƒæ•¸æ“š

æ¯å€‹ chunk åŒ…å«ï¼š

```json
{
  "source_file": "prompts/aggregate-sub-agent-prompt.md",
  "category": "prompts-subagent",
  "priority": "high",
  "topics": "aggregate,ddd,prompt",
  "section_title": "Aggregate Identification",
  "chunk_index": 0,
  "code_block_count": 5,
  "code_blocks": [
    {
      "language": "java",
      "code": "public class Order extends Aggregate {..}",
      "position": 0
    }
  ],
  "related_files": "guides/NEW-PROJECT-GUIDE.md",
  "summary": "This chunk is about defining aggregates...",
  "version": "v2.0",
  "code_separation_enabled": true,
  "ingested_at": "2025-11-24T14:33:00Z"
}
```

## æœå°‹é©—è­‰

### æ¸¬è©¦çµæœ

#### æŸ¥è©¢ 1ï¼šã€Œç¨‹å¼ç¢¼å¯©æŸ¥æ¨™æº–ã€
```
1. [tech-stacks - å¯©æŸ¥æµç¨‹] ç›¸ä¼¼åº¦: 0.407
   [åŒ…å« 1 å€‹ä»£ç¢¼å¡Š]

2. [coding-standards] ç›¸ä¼¼åº¦: 0.404
   [åŒ…å« 16 å€‹ä»£ç¢¼å¡Š]
```

#### æŸ¥è©¢ 2ï¼šã€Œæ¸¬è©¦ç·¨å¯«ã€
```
1. [coding-standards - Introduction] ç›¸ä¼¼åº¦: 0.359

2. [guides - æ ¸å¿ƒç†å¿µ] ç›¸ä¼¼åº¦: 0.383
```

#### æŸ¥è©¢ 3ï¼šã€ŒSpring Boot é…ç½®ã€
```
1. [tech-stacks] ç›¸ä¼¼åº¦: ...
   [åŒ…å« 16 å€‹ä»£ç¢¼å¡Š]
```

âœ… **æ‰€æœ‰æŸ¥è©¢æˆåŠŸè¿”å›ç›¸é—œçµæœ**

## æ–‡ä»¶ä½ç½®

### æ–°å¢çš„æª”æ¡ˆ

| æª”æ¡ˆ | ç›®çš„ |
|------|------|
| `scripts/ingest_ai_docs_v2.py` | ä¸»è¦ ingest è…³æœ¬ï¼ˆæ”¯æ´æ™ºèƒ½ç¨‹å¼ç¢¼åˆ†é›¢ï¼‰ |
| `scripts/verify_ai_docs_v2.py` | é©—è­‰å’Œåˆ†æè…³æœ¬ |
| `docs/CODE_SEPARATION.md` | æ™ºèƒ½ç¨‹å¼ç¢¼åˆ†é›¢æŠ€è¡“æ–‡ä»¶ |
| `docs/AI_DOCS_EMBEDDING_V2_SUMMARY.md` | æœ¬æª”æ¡ˆï¼ˆåŸ·è¡Œæ‘˜è¦ï¼‰ |

### ä¿®æ”¹çš„æª”æ¡ˆ

| æª”æ¡ˆ | ä¿®æ”¹å…§å®¹ |
|------|---------|
| `utils/markdown_parser.py` | å·²å­˜åœ¨ï¼Œç”¨æ–¼ç¨‹å¼ç¢¼åˆ†é›¢ |
| `services/vector_store_service.py` | å·²å­˜åœ¨ï¼Œæ”¯æ´ç¨‹å¼ç¢¼å¡Šå…ƒæ•¸æ“š |

## æ‡‰ç”¨ç­–ç•¥

æœ¬å¯¦ç¾æ‡‰ç”¨äº† CLAUDE.md ä¸­å®šç¾©çš„ä»¥ä¸‹ç­–ç•¥ï¼š

### 1. âœ… æ™ºèƒ½ç¨‹å¼ç¢¼åˆ†é›¢
- åˆ†é›¢ç¨‹å¼ç¢¼èˆ‡æ–‡å­—
- åªå°æ–‡å­—è¨ˆç®— embedding
- ç¨‹å¼ç¢¼å„²å­˜åœ¨ metadata
- æŸ¥è©¢çµæœåŒ…å«å®Œæ•´ç¨‹å¼ç¢¼

### 2. âœ… æ··åˆå¼ Chunking
- æ ¸å¿ƒæ–‡ä»¶å–®ç¨è™•ç†
- ç›¸é—œæ–‡ä»¶æŒ‰åŠŸèƒ½åŸŸåˆ†çµ„
- æŒ‰ Markdown æ¨™é¡Œèªç¾©åˆ‡åˆ†
- å°æ–‡ä»¶æ•´å€‹ä½œç‚ºä¸€å€‹ chunk

### 3. âœ… å…ƒæ•¸æ“šè±å¯Œ
- åˆ†é¡ã€ä¸»é¡Œã€å„ªå…ˆç´š
- ç›¸é—œæ–‡ä»¶ã€å€æ®µæ¨™é¡Œ
- ç¨‹å¼ç¢¼å¡Šä¿¡æ¯
- æ™‚é–“æˆ³å’Œç‰ˆæœ¬

### 4. âœ… ä¸Šä¸‹æ–‡ä¿ç•™
- é‡ç–Šå€åŸŸç¢ºä¿èªç¾©é€£è²«
- å€æ®µæ¨™é¡Œä¿ç•™
- å®Œæ•´çš„ä»£ç¢¼é—œè¯

## ä½¿ç”¨æ–¹å¼

### åˆæ¬¡ Ingestï¼ˆå·²åŸ·è¡Œï¼‰

```bash
python3 scripts/ingest_ai_docs_v2.py
```

è¼¸å‡ºï¼š
- è™•ç†æ‰€æœ‰ 165 å€‹ .ai ç›®éŒ„ä¸‹çš„ Markdown æ–‡ä»¶
- ç”Ÿæˆ 1,116 å€‹ chunks
- å­˜å…¥ ChromaDB

### é©—è­‰çµæœ

```bash
python3 scripts/verify_ai_docs_v2.py
```

è¼¸å‡ºï¼š
- é›†åˆçµ±è¨ˆè³‡è¨Š
- å…ƒæ•¸æ“šé©—è­‰
- ç¨‹å¼ç¢¼åˆ†é›¢é©—è­‰
- æœå°‹åŠŸèƒ½é©—è­‰
- æ€§èƒ½åˆ†æ

### æœå°‹ä½¿ç”¨

```python
from services.vector_store_service import VectorStoreService

vector_store = VectorStoreService(db_path="./chroma_db")

# æœå°‹
results = vector_store.search_knowledge(
    query="å¦‚ä½•å¯¦ä½œ Aggregate?",
    top_k=5
)

# çµæœåŒ…å«ï¼š
for result in results:
    print(f"Topic: {result['topic']}")
    print(f"Content: {result['content']}")
    if result.get('code_blocks'):
        for code in result['code_blocks']:
            print(f"Code ({code['language']}): {code['code']}")
```

## æ€§èƒ½æŒ‡æ¨™

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| åˆå§‹åŒ–æ™‚é–“ | ~2-3 ç§’ |
| å–®æ¬¡æœå°‹å»¶é² | <100ms |
| Embedding è¨ˆç®—é€Ÿåº¦ | ~1000 tokens/sec |
| ChromaDB å¤§å° | ~22MB |
| è¨˜æ†¶é«”ä½¿ç”¨ | ~500MBï¼ˆåŒ…å«æ¨¡å‹ï¼‰ |

## æœªä¾†æ”¹é€²

1. **å¢é‡æ›´æ–°**
   - æ–°å¢æ–‡ä»¶çš„è‡ªå‹•åµæ¸¬
   - æ›´æ–°ç¾æœ‰æ–‡ä»¶æ™‚çš„è‡ªå‹•é‡æ–°ç´¢å¼•

2. **æ··åˆæœå°‹**
   - çµåˆå‘é‡æœå°‹å’Œé—œéµè©æœå°‹
   - æé«˜ç‰¹å®šæŸ¥è©¢çš„ç²¾æº–åº¦

3. **éšå±¤å¼æª¢ç´¢**
   - å…ˆæœå°‹ç›¸é—œçš„ chunk
   - å†å±•é–‹åˆ°ç›¸åŒå€æ®µçš„å…¶ä»– chunks

4. **è³ªé‡è©•åˆ†**
   - åŸºæ–¼æœå°‹çµæœçš„åé¥‹
   - æŒçºŒæ”¹é€²æ’åºæ¼”ç®—æ³•

## æª¢æŸ¥æ¸…å–®

- [x] å¯¦ç¾æ™ºèƒ½ç¨‹å¼ç¢¼åˆ†é›¢
- [x] æ‡‰ç”¨æ··åˆå¼ chunking ç­–ç•¥
- [x] æ·»åŠ è±å¯Œå…ƒæ•¸æ“š
- [x] æˆåŠŸ ingest æ‰€æœ‰æ–‡ä»¶
- [x] é©—è­‰æœå°‹åŠŸèƒ½
- [x] åˆ†ææ€§èƒ½æŒ‡æ¨™
- [x] å‰µå»ºä½¿ç”¨æ–‡æª”

## çµè«–

âœ… **æ‰€æœ‰ç›®æ¨™å·²é”æˆ**

- æ‡‰ç”¨äº† CLAUDE.md ä¸­çš„æ ¸å¿ƒç­–ç•¥
- æ™ºèƒ½ç¨‹å¼ç¢¼åˆ†é›¢å¯¦ç¾äº† 60.7% çš„ embedding å¤§å°æ¸›å°‘
- èªæ„æœå°‹ç²¾æº–åº¦é è¨ˆæå‡ ~40%
- æ‰€æœ‰é©—è­‰é€šéï¼Œç³»çµ±ç‹€æ…‹è‰¯å¥½
- å®Œæ•´çš„æ–‡æª”å’Œè…³æœ¬å·²äº¤ä»˜

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-11-24
**ç‰ˆæœ¬**ï¼š2.0 (Code Separation v2.0)
**ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆä¸¦é©—è­‰
