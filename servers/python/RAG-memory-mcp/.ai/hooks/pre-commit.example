#!/bin/bash
# ====================================================================
# Smart Git Pre-commit Hook
# 
# Purpose: Êô∫ËÉΩÊ™¢Êü•Áõ∏ÈóúÊ™îÊ°à‰øÆÊîπÔºåÂè™Âú®ÈúÄË¶ÅÊôÇÂü∑Ë°åÂ∞çÊáâÁöÑÊ™¢Êü•
# Author: AI Assistant
# Date: 2025-09-02
# ====================================================================

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Flag to track if any check failed
FAILED=0

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}üß† Smart Pre-commit Hook Running${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# ====================================================================
# Check 1: Coding Standards
# ====================================================================
if echo "$STAGED_FILES" | grep -E "coding-standards|\.ai/prompts.*\.md" > /dev/null; then
    echo -e "${YELLOW}üìù Detected coding standards or prompts changes${NC}"
    echo -e "${BLUE}Running coding standards check...${NC}"
    echo ""
    
    # Change to aiscrum directory for script execution
    cd aiscrum
    if ./.ai/scripts/check-coding-standards.sh; then
        echo -e "${GREEN}‚úÖ Coding standards check passed${NC}"
    else
        echo -e "${RED}‚ùå Coding standards check failed${NC}"
        FAILED=1
    fi
    cd ..
    echo ""
fi

# ====================================================================
# Check 2: JPA Projection Configuration
# ====================================================================
if echo "$STAGED_FILES" | grep -E "Projection\.java|JpaConfiguration\.java" > /dev/null; then
    echo -e "${YELLOW}üóÉÔ∏è Detected JPA Projection or Configuration changes${NC}"
    echo -e "${BLUE}Running JPA projection configuration check...${NC}"
    echo ""
    
    cd aiscrum
    if ./.ai/scripts/check-jpa-projection-config.sh 2>&1 | tail -5 | grep -q "‚úì All JPA Projections are properly configured"; then
        echo -e "${GREEN}‚úÖ JPA projection configuration check passed${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è JPA projection configuration may have issues${NC}"
        echo "Run: cd aiscrum && ./.ai/scripts/check-jpa-projection-config.sh"
        # Not failing commit for this, just warning
    fi
    cd ..
    echo ""
fi

# ====================================================================
# Check 3: Repository Compliance
# ====================================================================
if echo "$STAGED_FILES" | grep -E "Repository\.java|repository/.*\.java" > /dev/null; then
    echo -e "${YELLOW}üì¶ Detected Repository changes${NC}"
    echo -e "${BLUE}Running repository compliance check...${NC}"
    echo ""
    
    cd aiscrum
    if ./.ai/scripts/check-repository-compliance.sh 2>&1 | grep -q "No custom Repository interfaces found"; then
        echo -e "${GREEN}‚úÖ Repository compliance check passed${NC}"
    else
        echo -e "${RED}‚ùå Repository compliance check failed${NC}"
        echo "Found custom Repository interfaces (violation of ADR-029)"
        FAILED=1
    fi
    cd ..
    echo ""
fi

# ====================================================================
# Check 4: Mapper Compliance
# ====================================================================
if echo "$STAGED_FILES" | grep -E "Mapper\.java" > /dev/null; then
    echo -e "${YELLOW}üîÑ Detected Mapper changes${NC}"
    echo -e "${BLUE}Running mapper compliance check...${NC}"
    echo ""
    
    cd aiscrum
    ./.ai/scripts/check-mapper-compliance.sh
    # Mapper check is informational, not blocking
    echo -e "${GREEN}‚úÖ Mapper check completed (informational)${NC}"
    cd ..
    echo ""
fi

# ====================================================================
# Check 5: Maven Compilation (if Java files changed)
# ====================================================================
if echo "$STAGED_FILES" | grep -E "\.java$" > /dev/null; then
    echo -e "${YELLOW}‚òï Detected Java changes${NC}"
    echo -e "${BLUE}Running Maven compilation check...${NC}"
    echo ""
    
    cd aiscrum
    if /opt/homebrew/bin/mvn compile -q 2>&1 | grep -E "ERROR|FAILURE" > /dev/null; then
        echo -e "${RED}‚ùå Maven compilation failed${NC}"
        FAILED=1
    else
        echo -e "${GREEN}‚úÖ Maven compilation passed${NC}"
    fi
    cd ..
    echo ""
fi

# ====================================================================
# Summary
# ====================================================================
if [ $FAILED -eq 0 ]; then
    if echo "$STAGED_FILES" | grep -E "coding-standards|Projection|Repository|Mapper|\.java" > /dev/null; then
        echo -e "${GREEN}========================================${NC}"
        echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
        echo -e "${GREEN}========================================${NC}"
    else
        echo -e "${BLUE}‚ÑπÔ∏è No relevant files to check${NC}"
    fi
    exit 0
else
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}‚ùå Pre-commit checks failed!${NC}"
    echo -e "${RED}========================================${NC}"
    echo ""
    echo -e "${YELLOW}To bypass checks (use with caution):${NC}"
    echo -e "  git commit --no-verify"
    echo ""
    exit 1
fi